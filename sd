#
# Prepare Bootable SD Card with Lubuntu as OS for Cubietruck
#
# (Main steps taken from the official Cubietruck Lubuntu bootable SD card instrucctions)
#
# ______________________________________________________________________________________

# Download Required Files
sudo wget -N "http://geekdome.net/x2go/lubuntu13/u-boot-sunxi-with-spl-ct-20131102.bin"
#sudo wget -N "http://geekdome.net/x2go/lubuntu13/bootfs-part1.tar.bz2"
#sudo wget -N "http://geekdome.net/x2go/lubuntu13/edx_ubuntu13_17dec2014.tar.bz2"
sudo wget -N "http://geekdome.net/x2go/trusty/trusty-boot.tar.bz2" -O bootfs-part1.tar.bz2
sudo wget -N "http://geekdome.net/x2go/trusty/trusty-root.tar.bz2" -O rootfs-part2.tar.bz2

# Variables
#
# The following assignation of variable "card" doesn't have effect.
# When the script find this assignation it will set as its value to the
# the command-line parameter that comes after the name of this file.
#
card=/dev/sdc

# Clean SD Card
sudo dd if=/dev/zero of=${card} bs=1024 seek=544 count=128

# Make Bootable SD Card
sudo dd if=u-boot-sunxi-with-spl-ct-20131102.bin of=${card} bs=1024 seek=8

# Partition and Make File Systems on Partitions
sudo sfdisk ${card} < sd_card_partitions.out
sudo mkfs.ext2 ${card}1
sudo mkfs.ext4 ${card}2

# Copy System Files to SD Card
[ -d /tmp/sdd1 ] || mkdir /tmp/sdd1 
[ -d /tmp/sdd2 ] || mkdir /tmp/sdd2
sudo mount -t ext2 ${card}1 /tmp/sdd1
sudo mount -t ext4 ${card}2 /tmp/sdd2
sudo tar -C /tmp/sdd1 -jxvf bootfs-part1.tar.bz2
sudo tar -C /tmp/sdd2 -jxvf rootfs-part2.tar.bz2
sync

## Copy EDX Required Installation Files to /home/linaro/EDX on SD Card
#[ -d /tmp/sdd2/home/linaro/EDX ] || mkdir /tmp/sdd2/home/linaro/EDX
#d="/tmp/sdd2/home/linaro/EDX" for f in README.md execute update edxPRE fixes edx apparmorFIX text_replacements.xml ; do [ -f $d/$f ] || cp $f $d/$f ; done

# Unmount SD Card Partitions
sudo umount /tmp/sdd1
sudo umount /tmp/sdd2
sudo rmdir /tmp/sdd1 /tmp/sdd2

# Make SD Card Safe to remove (Eject) 
sudo eject ${card}
